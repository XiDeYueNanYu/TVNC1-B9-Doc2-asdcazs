<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>学习越南语请联系Wx:XiDeYueNanYu</title>
    <style>
        body {
            background-color: #f7fbf3;
            margin-bottom: 60px;
        }
        #infoBox { 
            width: 100%; 
            max-width: 700px;
            height: 100px; 
            margin: 0 auto; 
            border: 1px solid #ccc; 
            background: #68838B; 
            color: #D2B48C; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: clamp(40px, 5vw, 60px);
            font-weight: bold;
        }
        #contactBox { 
            width: 100%; 
            max-width: 700px;
            height: 45px; 
            margin: 0px auto; 
            border: 1px solid #ccc; 
            background: #68838B; 
            color: #D2B48C; 
            display: flex; 
            align-items: center; 
            justify-content: left; 
            padding-left: 20px;
            font-size: clamp(12px, 2vw, 15px); 
            font-weight: bold;
        }
        .image-frame {
            max-width: 700px;
            margin: 20px auto 0 auto;
            border: 10px solid #957652;
            border-radius: 10px;
            background-color: #ffffff;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            display: none;
            overflow: hidden;
        }
        .image-frame img {
            width: 100%;
            height: auto;
            display: block;
        }
        .content-box {
            max-width: 700px;
            margin: 20px auto;
            padding: 50px;
            border: 10px solid #957652;
            border-radius: 10px;
            background-color: #ffffff;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            font-size: 30px;
            font-family: Arial;
            color: #222322;
            line-height: 3;
            text-align: justify;
        }
        .translated-word {
            position: relative;
            display: inline-block;
            white-space: nowrap;
            line-height: 1.3;
            background-color: #bfcdbf;
            color: #000000;
            padding: 4px 4px;
            border-radius: 2px;
        }
        .translation {
            position: absolute;
            top: -29px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 18px;
            background-color: #eddabc;
            color: #313a2d;
            padding: 4px 4px;
            border-radius: 1px;
            white-space: nowrap;
            z-index: 1;
            line-height: 1;
        }
        .original {
            display: inline;
            line-height: 1;
        }
        .floating-controls {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            text-align: center;
            display: block;
            z-index: 1000;
        }
        #audioPlayer {
            width: 100%;
            margin-bottom: 10px;
        }
        .time-row {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .time-box-group {
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        .button-group {
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        .floating-controls p#timeDisplay {
            font-size: 28px;
            color: #FFFFFF;
            background-color: #000000;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            margin: 0;
        }
        .floating-controls .time-box {
            font-size: 16px;
            color: #FFFFFF;
            background-color: #555555;
            padding: 5px 10px;
            border-radius: 5px;
            min-width: 60px;
        }
        .tua-buttons {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        .control-button {
            width: 50px;
            height: 50px;
            background-color: #363535;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: inline-flex;
            justify-content: center;
            align-items: center;
        }
        .control-button:disabled {
            background-color: #888888;
            cursor: not-allowed;
        }
        .control-button:hover:not(:disabled) {
            background-color: #000000;
        }
        .pause-play-button {
            background-color: #FF4500;
        }
        .pause-play-button:hover {
            background-color: #CC3700;
        }
        .toggle-button {
            background-color: #4682B4;
        }
        .toggle-button:hover {
            background-color: #36648B;
        }
        .loop-button {
            background-color: #3c923c;
        }
        .loop-button:hover {
            background-color: #347d34;
        }
        .clear-button {
            background-color: #bc3f13;
        }
        .clear-button:hover {
            background-color: #d15124;
        }
        .active {
            background-color: #ffffff; 
            border-radius: 5px;
        }
        @media (max-width: 400px) {
            .control-button {
                width: 40px;
                height: 40px;
                font-size: 14px;
            }
            .floating-controls p#timeDisplay {
                font-size: 20px;
            }
            .floating-controls .time-box {
                font-size: 12px;
                min-width: 50px;
            }
        }
        #quizContainer {
            display: none;
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            color: #53686f;
            font-size: 25px;
            font-weight: bold;
        }
        .question {
            margin-bottom: 20px;
            padding: 18px;
            color: #53686f;
            border: 5px solid #53686f;
            border-radius: 10px;
            background-color: #ffffff;
            font-size: 20px;
            font-weight: bold;
        }
        .options label {
            display: block;
            margin: 15px 0;
            cursor: pointer;
            color: #21292c;
            font-size: 16px;
            font-weight: bold;
        }
        #result {
            margin-top: 20px;
            padding: 10px;
            display: none;
            border: 5px solid #53686f;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            background-color: #ffffff;
            color: #007a33;
        }
        .wrong-answer {
            color: #f65936;
            margin: 10px 0;
            font-size: 16px;
            font-weight: bold;
        }
        #submitQuiz {
            font-family: Arial, sans-serif;
            padding: 10px 20px;
            border: 3px solid #53686f;
            background-color: #FF6820;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
        }
        #submitQuiz:hover {
            background-color: #ff844a;
        }
        .floating-mode-bar {
            position: fixed;
            bottom: 0px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #68838B;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0px 5px rgba(0, 0, 0, 1);
            display: flex;
            justify-content: center;
            gap: 20px;
            z-index: 1000;
            width: 900px;
        }
        .mode-button {
            padding: 10px 20px;
            border: 0px solid #ccc;
            background: #95a8ad;
            color: #293437;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 5px;
            transition: border-color 0.3s;
        }
        .mode-button.active {
            border: 2px solid #ffffff;
            background: #f0f0f0;
            color: #293437;
        }
        /* Mobile styles */
        @media (max-width: 768px) { 
            body {
                background-color: #f7fbf3;
                margin-bottom: 60px;
            }
            #infoBox { 
                width: 90%; 
                height: 120px; 
                margin: 0 auto; 
                border: 1px solid #ccc; 
                background: #68838B; 
                color: #D2B48C; 
                display: flex; 
                align-items: center; 
                justify-content: center; 
                font-size: 60px; 
                font-weight: bold;
            }
            #contactBox { 
                width: 90%; 
                height: 50px; 
                margin: 0px auto; 
                border: 1px solid #ccc; 
                background: #68838B; 
                color: #D2B48C; 
                display: flex; 
                align-items: center; 
                justify-content: left; 
                padding-left: 20px;
                font-size: 20px; 
                font-weight: bold;
            }
            .image-frame {
                width: 90%;
                max-width: 700px;
                margin: 10 screen auto 0 auto;
                border: 10px solid #957652;
                border-radius: 10px;
                background-color: #ffffff;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
                display: none;
                overflow: hidden;
            }
            .image-frame img {
                width: 100%;
                height: auto;
                display: block;
            }
            .content-box {
                max-width: 700px;
                margin: 10px auto;
                padding: 20px;
                padding-top: 50px;
                padding-bottom: 90px;
                border: 10px solid #957652;
                border-radius: 10px;
                background-color: #ffffff;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
                font-size: 19px;
                font-family: Arial;
                color: #222322;
                line-height: 3.5;
                text-align: justify;
            }
            .translated-word {
                position: relative;
                display: inline-block;
                white-space: nowrap;
                line-height: 1.3;
                background-color: #bfcdbf;
                color: #000000;
                padding: 3px 3px;
                border-radius: 2px;
            }
            .translation {
                position: absolute;
                top: -25px;
                left: 50%;
                transform: translateX(-50%);
                font-size: 13px;
                background-color: #eddabc;
                color: #313a2d;
                padding: 4px 4px;
                border-radius: 1px;
                white-space: nowrap;
                z-index: 1;
                line-height: 1;
            }
            .original {
                display: inline;
                line-height: 1;
            }
            .floating-controls {
                position: fixed;
                top: 20px;
                right: 20px;
                background-color: #f0f0f0;
                padding: 10px;
                border-radius: 5px;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
                text-align: center;
                display: block;
                z-index: 1000;
            }
            #audioPlayer {
                width: 100%;
                margin-bottom: 10px;
            }
            .time-row {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 10px;
                margin-bottom: 10px;
            }
            .time-box-group {
                display: flex;
                justify-content: center;
                gap: 10px;
            }
            .button-group {
                display: flex;
                justify-content: center;
                gap: 10px;
            }
            .floating-controls p#timeDisplay {
                font-size: 28px;
                color: #FFFFFF;
                background-color: #000000;
                padding: 5px 10px;
                border-radius: 5px;
                cursor: pointer;
                margin: 0;
            }
            .floating-controls .time-box {
                font-size: 16px;
                color: #FFFFFF;
                background-color: #555555;
                padding: 5px 10px;
                border-radius: 5px;
                min-width: 60px;
            }
            .tua-buttons {
                display: flex;
                justify-content: center;
                gap: 5px;
                margin-bottom: 10px;
                flex-wrap: wrap;
            }
            .action-buttons {
                display: flex;
                justify-content: center;
                gap: 10px;
            }
            .control-button {
                width: 50px;
                height: 50px;
                background-color: #363535;
                color: white;
                border: none;
                border-radius: 50%;
                font-size: 16px;
                font-weight: bold;
                cursor: pointer;
                display: inline-flex;
                justify-content: center;
                align-items: center;
            }
            .control-button:disabled {
                background-color: #888888;
                cursor: not-allowed;
            }
            .control-button:hover:not(:disabled) {
                background-color: #000000;
            }
            .pause-play-button {
                background-color: #FF4500;
            }
            .pause-play-button:hover {
                background-color: #CC3700;
            }
            .toggle-button {
                background-color: #4682B4;
            }
            .toggle-button:hover {
                background-color: #36648B;
            }
            .loop-button {
                background-color: #3c923c;
            }
            .loop-button:hover {
                background-color: #347d34;
            }
            .clear-button {
                background-color: #bc3f13;
            }
            .clear-button:hover {
                background-color: #d15124;
            }
            .active {
                background-color: #ffffff; 
                border-radius: 5px;
            }
            @media (max-width: 400px) {
                .control-button {
                    width: 40px;
                    height: 40px;
                    font-size: 14px;
                }
                .floating-controls p#timeDisplay {
                    font-size: 20px;
                }
                .floating-controls .time-box {
                    font-size: 12px;
                    min-width: 50px;
                }
            }
            #quizContainer {
                display: none;
                font-family: Arial, sans-serif;
                max-width: 800px;
                margin: 20px auto;
                padding: 20px;
                color: #53686f;
                font-size: 25px;
                font-weight: bold;
            }
            .question {
                margin-bottom: 20px;
                padding: 18px;
                color: #53686f;
                border: 5px solid #53686f;
                border-radius: 10px;
                background-color: #ffffff;
                font-size: 16px;
                font-weight: bold;
            }
            .options label {
                display: block;
                margin: 15px 0;
                cursor: pointer;
                color: #21292c;
                font-size: 16px;
                font-weight: bold;
            }
            #result {
                margin-top: 20px;
                padding: 10px;
                display: none;
                border: 5px solid #53686f;
                border-radius: 5px;
                font-size: 16px;
                font-weight: bold;
                background-color: #ffffff;
                color: #007a33;
            }
            .wrong-answer {
                color: #f65936;
                margin: 10px 0;
                font-size: 16px;
                font-weight: bold;
            }
            #submitQuiz {
                font-family: Arial, sans-serif;
                padding: 10px 20px;
                border: 3px solid #53686f;
                background-color: #FF6820;
                border-radius: 5px;
                color: white;
                cursor: pointer;
                font-size: 18px;
                font-weight: bold;
            }
            #submitQuiz:hover {
                background-color: #ff844a;
            }
            .floating-mode-bar {
                position: fixed;
                bottom: 0px;
                left: 50%;
                transform: translateX(-50%);
                background-color: #68838B;
                padding: 10px;
                border-radius: 5px;
                box-shadow: 0 0px 5px rgba(0, 0, 0, 1);
                display: flex;
                justify-content: center;
                gap: 20px;
                z-index: 1000;
                width: 100%;
            }
            .mode-button {
                padding: 10px 20px;
                border: 0px solid #ccc;
                background: #95a8ad;
                color: #293437;
                font-size: 20px;
                font-weight: bold;
                cursor: pointer;
                border-radius: 5px;
                transition: border-color 0.3s;
            }
            .mode-button.active {
                border: 2px solid #ffffff;
                background: #f0f0f0;
                color: #293437;
            }
        }
    </style>
</head>
<body>
    <div id="infoBox">习得越南语</div>
    <div id="contactBox">讲师-阮玉煌 | Weixin：XiDeYueNanYu</div>
    <div id="contentContainer">
        <div class="image-frame" id="imageFrame">
            <img id="contentImage" src="" alt="Content Image">
        </div>
        <div class="content-box" id="content"></div>
    </div>
    <div id="quizContainer">
        <h1>回答下面问题</h1>
        <form id="quizForm">
            <div id="questions"></div>
            <button type="button" id="submitQuiz" onclick="checkAnswers()">提交</button>
        </form>
        <div id="result"></div>
    </div>
    <div class="floating-controls" id="floatingControls">
        <audio id="audioPlayer" src="lesson.mp3" controls></audio>
        <div class="time-row">
            <p id="timeDisplay">00:00</p>
            <div class="time-box-group">
                <span class="time-box" id="loopStart">--:--</span>
                <span class="time-box" id="loopEnd">--:--</span>
            </div>
            <div class="button-group">
                <button class="control-button loop-button" id="loopButton">听</button>
                <button class="control-button clear-button" id="clearButton">删</button>
            </div>
        </div>
        <div class="tua-buttons">
            <button class="control-button" id="rewind5sButton">-5s</button>
            <button class="control-button" id="rewind1sButton">-1s</button>
            <button class="control-button" id="forward1sButton">+1s</button>
            <button class="control-button" id="forward5sButton">+5s</button>
        </div>
        <div class="action-buttons">
            <button class="control-button pause-play-button" id="pausePlayButton">播</button>
            <button class="control-button toggle-button" id="toggleControlsButton">藏</button>
        </div>
    </div>
    <div class="floating-mode-bar">
        <button class="mode-button active" id="contentMode">内容</button>
        <button class="mode-button" id="quizMode">回答问题</button>
    </div>

    <script>

const textContentData = [
    `THÔNG TIN CHO BẠN
Trong thời gian sống ở Việt Nam, bạn có thể thay đổi một vài thói quen trước đây của mình để có thể thích nghi với cuộc sống ở đây. Điều đó sẽ tốt hơn cho bạn. Ví dụ như:
Bạn nên có thói quen đi ngủ sớm hơn, dậy sớm, tập thể dục, tắm vào buổi sáng sớm, vì thời tiết ở Việt Nam thường nóng, ẩm, dậy muộn dễ có cảm giác mệt mỏi. Nếu bạn tạo được cho mình những thói quen này, bạn sẽ cảm thấy hoàn toàn thoải mái và thích nghi tốt hơn với cuộc sống ở xứ nhiệt đới này.
Khi đi xe ôm hoặc xích lô, bạn cần hỏi giá trước khi lên xe. Nếu không, khi bạn đến nơi, bạn có thể phải trả mức giá cao hơn nhiều so với thực tế.
Bạn nên tạo thói quen cất giữ tiền, điện thoại cẩn thận, khóa xe trước khi vào nơi công cộng để đảm bảo an toàn.`
];
const dictionary = {
    "thông tin": "信息",
    "thời gian": "时间",
    "sống": "生活",
    "Việt Nam": "越南",
    "thay đổi": "改变",
    "thói quen": "习惯",
    "thích nghi": "适应",
    "cuộc sống": "生活",
    "tốt": "好",
    "ví dụ": "例如",
    "đi ngủ": "睡觉",
    "sớm": "早",
    "dậy": "起床",
    "tập thể dục": "锻炼",
    "tắm": "洗澡",
    "buổi sáng": "早晨",
    "thời tiết": "天气",
    "nóng": "热",
    "ẩm": "潮湿",
    "muộn": "晚",
    "cảm giác": "感觉",
    "mệt mỏi": "疲劳",
    "tạo": "养成",
    "hoàn toàn": "完全",
    "thoải mái": "舒适",
    "xứ nhiệt đới": "热带地区",
    "đi xe ôm": "坐摩托车出租车",
    "xích lô": "三轮车",
    "hỏi giá": "问价",
    "lên xe": "上车",
    "đến nơi": "到达",
    "trả": "支付",
    "mức giá": "价格",
    "cao": "高",
    "thực tế": "实际",
    "cất giữ": "保管",
    "tiền": "钱",
    "điện thoại": "手机",
    "cẩn thận": "小心",
    "khóa xe": "锁车",
    "nơi công cộng": "公共场所",
    "đảm bảo": "确保",
    "an toàn": "安全"
};
const quizData = [
    {
        question: "Theo bài đọc, vì sao nên tắm vào buổi sáng sớm ở Việt Nam?",
        options: ["Để tránh bị cảm lạnh do gió mùa", "Vì đó là thói quen của người Việt", "Do thời tiết nóng ẩm, buổi sáng tạo cảm giác dễ chịu hơn", "Vì buổi tối thường không có nước nóng"],
        correct: "Do thời tiết nóng ẩm, buổi sáng tạo cảm giác dễ chịu hơn"
    },
    {
        question: "Theo bài, điều gì xảy ra nếu không hỏi giá trước khi đi xe ôm hoặc xích lô?",
        options: ["Có thể bị lạc đường vì tài xế không rõ điểm đến", "Không thể biết được tài xế có uy tín hay không", "Dễ bị từ chối vì không mặc cả trước", "Có thể phải trả giá cao hơn nhiều so với thực tế"],
        correct: "Có thể phải trả giá cao hơn nhiều so với thực tế"
    },
    {
        question: "Tác giả khuyên nên dậy sớm vì lý do nào sau đây?",
        options: ["Có thể ăn sáng cùng người bản địa", "Dậy muộn dễ cảm thấy mệt trong thời tiết nóng ẩm", "Buổi sáng ít ồn ào, dễ tập trung học", "Tránh kẹt xe giờ cao điểm"],
        correct: "Dậy muộn dễ cảm thấy mệt trong thời tiết nóng ẩm"
    },
    {
        question: "Thói quen nào không được nhắc đến trong bài như một biện pháp thích nghi?",
        options: ["Cất giữ điện thoại cẩn thận", "Mua bảo hiểm du lịch", "Tập thể dục buổi sáng", "Khóa xe trước khi vào nơi công cộng"],
        correct: "Mua bảo hiểm du lịch"
    },
    {
        question: "Theo bài, việc thay đổi thói quen cá nhân có lợi gì?",
        options: ["Giúp hoà nhập nhanh với cộng đồng địa phương", "Tránh được các rủi ro về sức khoẻ và tài chính", "Giúp học tiếng Việt nhanh hơn", "Cảm thấy thoải mái và thích nghi tốt hơn"],
        correct: "Cảm thấy thoải mái và thích nghi tốt hơn"
    },
    {
        question: "Câu “Nếu bạn tạo được cho mình những thói quen này, bạn sẽ cảm thấy hoàn toàn thoải mái…” hàm ý điều gì?",
        options: ["Những thói quen mới cần thời gian dài để hình thành", "Sự thích nghi tốt phụ thuộc vào việc thay đổi thói quen cá nhân", "Ai cũng phải làm theo thói quen của người Việt", "Chỉ có người trẻ mới dễ dàng thay đổi"],
        correct: "Sự thích nghi tốt phụ thuộc vào việc thay đổi thói quen cá nhân"
    },
    {
        question: "Cách viết của tác giả thể hiện thái độ như thế nào?",
        options: ["Chỉ trích thói quen cũ của người nước ngoài", "Thân thiện và đưa ra lời khuyên thực tế", "Cứng nhắc và áp đặt người đọc", "Hài hước và mang tính giải trí"],
        correct: "Thân thiện và đưa ra lời khuyên thực tế"
    },
    {
        question: "Có thể suy ra người viết hướng bài đọc này tới đối tượng nào?",
        options: ["Người bản xứ muốn sống ở thành phố", "Du khách hoặc người nước ngoài sống tại Việt Nam", "Học sinh cần học kỹ năng sống", "Người Việt chuẩn bị ra nước ngoài"],
        correct: "Du khách hoặc người nước ngoài sống tại Việt Nam"
    },
    {
        question: "Việc khóa xe và cất giữ tiền cẩn thận là để làm gì?",
        options: ["Tuân thủ quy định của chính quyền", "Đề phòng bị cảnh sát phạt", "Đảm bảo an toàn cá nhân và tránh mất cắp", "Không gây phiền phức cho người khác"],
        correct: "Đảm bảo an toàn cá nhân và tránh mất cắp"
    },
    {
        question: "Có thể suy ra lý do tác giả nhấn mạnh thời tiết ở Việt Nam là gì?",
        options: ["Để giải thích vì sao người Việt thích tắm nhiều lần", "Để thuyết phục người đọc thay đổi sinh hoạt cho phù hợp", "Để chỉ trích môi trường sống ở Việt Nam", "Để so sánh Việt Nam với các nước khác"],
        correct: "Để thuyết phục người đọc thay đổi sinh hoạt cho phù hợp"
    },
    {
        question: "Câu nào sau đây phản ánh đúng mối liên hệ giữa thời tiết và thói quen sinh hoạt?",
        options: ["Thời tiết lạnh khiến người ta phải ngủ nhiều hơn", "Khí hậu khô ráo thích hợp cho các hoạt động buổi chiều", "Thời tiết nóng ẩm buổi sáng khiến việc dậy sớm trở nên có lợi", "Mùa mưa kéo dài nên cần hạn chế ra ngoài"],
        correct: "Thời tiết nóng ẩm buổi sáng khiến việc dậy sớm trở nên có lợi"
    },
    {
        question: "Mục đích chính của bài viết là gì?",
        options: ["Cảnh báo về sự nguy hiểm khi sống ở Việt Nam", "Kể lại trải nghiệm cá nhân của người nước ngoài", "Hướng dẫn thích nghi với môi trường sống mới", "Phân tích sự khác biệt văn hoá giữa Việt Nam và phương Tây"],
        correct: "Hướng dẫn thích nghi với môi trường sống mới"
    }
];

        // Xử lý hiển thị văn bản với từ điển
        const content = document.getElementById('content');
        function renderText() {
            let html = textContentData[0].replace(/\n/g, "<br>");
            const sortedKeys = Object.keys(dictionary).sort((a, b) => b.length - a.length);
            const replacements = [];

            // Bước 1: Tìm và lưu trữ các cụm từ khớp
            sortedKeys.forEach(key => {
                const regex = new RegExp(`(\\b|[.,!?\\n\\s]|^)(${key.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})(\\b|[.,!?\\n\\s]|$)`, 'gi');
                let match;
                while ((match = regex.exec(html)) !== null) {
                    const start = match.index + match[1].length;
                    const end = start + match[2].length;
                    replacements.push({
                        start,
                        end,
                        original: match[2],
                        prefix: match[1],
                        suffix: match[3],
                        translation: dictionary[key]
                    });
                }
            });

            // Bước 2: Sắp xếp các lần khớp theo vị trí bắt đầu (start)
            replacements.sort((a, b) => a.start - b.start);

            // Bước 3: Lọc các lần khớp để loại bỏ chồng lấn
            const filteredReplacements = [];
            let lastEnd = -1;
            for (const replacement of replacements) {
                if (replacement.start >= lastEnd) {
                    filteredReplacements.push(replacement);
                    lastEnd = replacement.end;
                }
            }

            // Bước 4: Thay thế các cụm từ đã khớp, từ phải sang trái để tránh ảnh hưởng chỉ số
            for (let i = filteredReplacements.length - 1; i >= 0; i--) {
                const { start, end, original, prefix, suffix, translation } = filteredReplacements[i];
                const translatedHtml = `${prefix}<span class="translated-word"><span class="translation">${translation}</span><span class="original">${original}</span></span>${suffix}`;
                html = html.slice(0, start - prefix.length) + translatedHtml + html.slice(end + suffix.length);
            }

            content.innerHTML = html;
        }

        // Xử lý hiển thị ảnh
        const imageFrame = document.getElementById('imageFrame');
        const contentImage = document.getElementById('contentImage');
        const imageSrc = "anhminhhoa.jpg"; // Tên file ảnh cụ thể trong cùng thư mục
        function renderImage() {
            if (imageSrc) {
                contentImage.src = imageSrc;
                imageFrame.style.display = 'block';
            } else {
                imageFrame.style.display = 'none';
            }
        }

        // Gọi hàm renderText và renderImage khi khởi tạo
        renderText();
        renderImage();

        // Xử lý audio và bảng điều khiển
        const audioPlayer = document.getElementById("audioPlayer");
        const floatingControls = document.getElementById("floatingControls");
        const timeDisplay = floatingControls.querySelector("#timeDisplay");
        const loopStart = floatingControls.querySelector("#loopStart");
        const loopEnd = floatingControls.querySelector("#loopEnd");
        const loopButton = floatingControls.querySelector("#loopButton");
        const clearButton = floatingControls.querySelector("#clearButton");
        const rewind5sButton = floatingControls.querySelector("#rewind5sButton");
        const rewind1sButton = floatingControls.querySelector("#rewind1sButton");
        const forward1sButton = floatingControls.querySelector("#forward1sButton");
        const forward5sButton = floatingControls.querySelector("#forward5sButton");
        const pausePlayButton = floatingControls.querySelector("#pausePlayButton");
        const toggleControlsButton = floatingControls.querySelector("#toggleControlsButton");
        const tuaButtons = floatingControls.querySelector(".tua-buttons");

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function updateTimeDisplay(displayElement) {
            displayElement.textContent = formatTime(audioPlayer.currentTime);
        }

        let customLoopStart = null;
        let customLoopEnd = null;
        let clickCount = 0;
        let isLooping = false;

        const updateInterval = setInterval(() => updateTimeDisplay(timeDisplay), 1000);

        audioPlayer.ontimeupdate = function() {
            updateTimeDisplay(timeDisplay);
            if (isLooping && customLoopStart !== null && customLoopEnd !== null) {
                if (audioPlayer.currentTime >= customLoopEnd) {
                    audioPlayer.currentTime = customLoopStart;
                }
            }
        };

        timeDisplay.onclick = () => {
            if (audioPlayer.paused) {
                clickCount++;
                if (clickCount === 1) {
                    customLoopStart = audioPlayer.currentTime;
                    loopStart.textContent = formatTime(customLoopStart);
                } else if (clickCount === 2) {
                    customLoopEnd = audioPlayer.currentTime;
                    if (customLoopEnd <= customLoopStart) {
                        customLoopEnd = null;
                        loopEnd.textContent = "--:--";
                    } else {
                        loopEnd.textContent = formatTime(customLoopEnd);
                    }
                    clickCount = 0;
                }
            }
        };

        rewind5sButton.onclick = () => {
            if (!isLooping) {
                audioPlayer.currentTime = Math.max(0, audioPlayer.currentTime - 5);
                updateTimeDisplay(timeDisplay);
            }
        };
        rewind1sButton.onclick = () => {
            if (!isLooping) {
                audioPlayer.currentTime = Math.max(0, audioPlayer.currentTime - 1);
                updateTimeDisplay(timeDisplay);
            }
        };
        forward1sButton.onclick = () => {
            if (!isLooping) {
                audioPlayer.currentTime = Math.min(audioPlayer.duration, audioPlayer.currentTime + 1);
                updateTimeDisplay(timeDisplay);
            }
        };
        forward5sButton.onclick = () => {
            if (!isLooping) {
                audioPlayer.currentTime = Math.min(audioPlayer.duration, audioPlayer.currentTime + 5);
                updateTimeDisplay(timeDisplay);
            }
        };

        pausePlayButton.onclick = () => {
            if (audioPlayer.paused) {
                audioPlayer.play();
                pausePlayButton.textContent = "停";
            } else {
                audioPlayer.pause();
                pausePlayButton.textContent = "播";
            }
        };

        loopButton.onclick = () => {
            if (customLoopStart !== null && customLoopEnd !== null) {
                audioPlayer.currentTime = customLoopStart;
                audioPlayer.play();
                isLooping = true;
                rewind5sButton.disabled = true;
                rewind1sButton.disabled = true;
                forward1sButton.disabled = true;
                forward5sButton.disabled = true;
            }
        };

        clearButton.onclick = () => {
            customLoopStart = null;
            customLoopEnd = null;
            loopStart.textContent = "--:--";
            loopEnd.textContent = "--:--";
            clickCount = 0;
            isLooping = false;
            rewind5sButton.disabled = false;
            rewind1sButton.disabled = false;
            forward1sButton.disabled = false;
            forward5sButton.disabled = false;
        };

        let controlsVisible = true;
        toggleControlsButton.onclick = () => {
            if (controlsVisible) {
                timeDisplay.style.display = "none";
                tuaButtons.style.display = "none";
                pausePlayButton.style.display = "none";
                loopStart.style.display = "none";
                loopEnd.style.display = "none";
                loopButton.style.display = "none";
                clearButton.style.display = "none";
                toggleControlsButton.textContent = "示";
                controlsVisible = false;
            } else {
                timeDisplay.style.display = "inline-block";
                tuaButtons.style.display = "flex";
                pausePlayButton.style.display = "inline-flex";
                loopStart.style.display = "inline-block";
                loopEnd.style.display = "inline-block";
                loopButton.style.display = "inline-flex";
                clearButton.style.display = "inline-flex";
                toggleControlsButton.textContent = "藏";
                controlsVisible = true;
            }
        };

        audioPlayer.onpause = audioPlayer.onended = function() {
            pausePlayButton.textContent = "播";
        };

        // Biến lưu trữ vị trí cuộn và lựa chọn
        let contentScrollPosition = 0;
        let quizScrollPosition = 0;
        let userSelections = {};
        let isSubmitted = false;

        // Hiển thị câu hỏi và khôi phục lựa chọn
        function loadQuiz() {
            const questionsDiv = document.getElementById('questions');
            questionsDiv.innerHTML = '';
            quizData.forEach((item, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question';
                
                const questionTitle = document.createElement('h3');
                questionTitle.textContent = `Câu ${index + 1}: ${item.question}`;
                questionDiv.appendChild(questionTitle);

                const optionsDiv = document.createElement('div');
                optionsDiv.className = 'options';
                
                item.options.forEach(option => {
                    const label = document.createElement('label');
                    const isChecked = userSelections[`question${index}`] === option ? 'checked' : '';
                    label.innerHTML = `
                        <input type="radio" name="question${index}" value="${option}" ${isChecked}>
                        ${option}
                    `;
                    optionsDiv.appendChild(label);
                });

                questionDiv.appendChild(optionsDiv);
                questionsDiv.appendChild(questionDiv);
            });

            // Khôi phục vị trí cuộn
            window.scrollTo(0, quizScrollPosition);
        }

        // Lưu lựa chọn của người dùng
        function saveSelections() {
            quizData.forEach((_, index) => {
                const selected = document.querySelector(`input[name="question${index}"]:checked`);
                if (selected) {
                    userSelections[`question${index}`] = selected.value;
                }
            });
        }

        // Kiểm tra đáp án
        function checkAnswers() {
            let score = 0;
            const total = quizData.length;
            let wrongAnswers = [];
            
            quizData.forEach((item, index) => {
                const selected = document.querySelector(`input[name="question${index}"]:checked`);
                if (selected) {
                    if (selected.value === item.correct) {
                        score++;
                    } else {
                        wrongAnswers.push({
                            question: item.question,
                            selected: selected.value,
                            correct: item.correct
                        });
                    }
                } else {
                    wrongAnswers.push({
                        question: item.question,
                        selected: "未选择",
                        correct: item.correct
                    });
                }
            });

            const resultDiv = document.getElementById('result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `
                <h3>YD-Visa-结果: ${score}/${total} 答案正确</h3>
                <p>比例: ${(score/total * 100).toFixed(2)}%</p>
            `;

            if (wrongAnswers.length > 0) {
                resultDiv.innerHTML += '<h4>错误答案:</h4>';
                wrongAnswers.forEach((wrong, index) => {
                    resultDiv.innerHTML += `
                        <div class="wrong-answer">
                            Câu ${quizData.findIndex(q => q.question === wrong.question) + 1}: ${wrong.question}<br>
                            你的选择: ${wrong.selected} - 正确答案: ${wrong.correct}
                        </div>
                    `;
                });
            } else {
                resultDiv.innerHTML += '<p>回答正确所有问题</p>';
            }

            resultDiv.scrollIntoView({ behavior: 'smooth' });
            isSubmitted = true; // Đánh dấu đã nộp bài
        }

        // Xử lý chế độ hiển thị
        const contentModeButton = document.getElementById('contentMode');
        const quizModeButton = document.getElementById('quizMode');
        const contentContainer = document.getElementById('contentContainer');
        const quizContainer = document.getElementById('quizContainer');

        contentModeButton.addEventListener('click', () => {
            // Lưu vị trí cuộn của quiz trước khi chuyển
            quizScrollPosition = window.scrollY;
            saveSelections(); // Lưu lựa chọn của người dùng
            
            contentContainer.style.display = 'block';
            quizContainer.style.display = 'none';
            contentModeButton.classList.add('active');
            quizModeButton.classList.remove('active');
            floatingControls.style.display = 'block';
            renderText();
            renderImage();
            
            // Khôi phục vị trí cuộn của content
            window.scrollTo(0, contentScrollPosition);
        });

        quizModeButton.addEventListener('click', () => {
            // Lưu vị trí cuộn của content trước khi chuyển
            contentScrollPosition = window.scrollY;
            saveSelections(); // Lưu lựa chọn của người dùng
            
            contentContainer.style.display = 'none';
            quizContainer.style.display = 'block';
            quizModeButton.classList.add('active');
            contentModeButton.classList.remove('active');
            floatingControls.style.display = 'none';
            
            // Reset lựa chọn nếu đã nộp bài
            if (isSubmitted) {
                userSelections = {};
                isSubmitted = false;
            }
            
            loadQuiz();
        });

        // Mặc định hiển thị nội dung
        contentContainer.style.display = 'block';
        quizContainer.style.display = 'none';
    </script>
</body>
</html>